<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="018-001" author="dms">
        <comment>Create document_type_fields table for configurable fields per document type</comment>
        <createTable tableName="document_type_fields">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_document_type_fields"/>
            </column>
            <column name="document_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="field_key" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="field_label" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="field_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="is_required" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="is_ocr_mappable" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="ocr_pattern" type="VARCHAR(500)"/>
            <column name="default_value" type="VARCHAR(500)"/>
            <column name="validation_rules" type="TEXT"/>
            <column name="field_options" type="TEXT"/>
            <column name="display_order" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(500)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
        <addUniqueConstraint tableName="document_type_fields"
                            columnNames="document_type, field_key"
                            constraintName="uk_document_type_field"/>
        <createIndex tableName="document_type_fields" indexName="idx_document_type_fields_type">
            <column name="document_type"/>
        </createIndex>
        <createIndex tableName="document_type_fields" indexName="idx_document_type_fields_active">
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <changeSet id="018-002" author="dms">
        <comment>Insert default fields for TENDER_NOTICE document type</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, ocr_pattern, display_order, description)
            VALUES 
            ('TENDER_NOTICE', 'tenderId', 'Tender ID', 'text', true, true, '(?i)tender\\s*(id|number|no\\.?|#)\\s*[:\\-]?\\s*([A-Z0-9\\-/]+)', 1, 'Unique identifier for the tender'),
            ('TENDER_NOTICE', 'tenderType', 'Tender Type', 'select', true, false, null, 2, 'Type of tender (e.g., Open, Limited, Single Source)'),
            ('TENDER_NOTICE', 'tenderDate', 'Tender Date', 'date', true, true, '(?i)(tender|issue|publish)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 3, 'Date when tender was issued'),
            ('TENDER_NOTICE', 'closingDate', 'Closing Date', 'date', true, true, '(?i)(closing|deadline|expiry|expiration)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 4, 'Last date for tender submission'),
            ('TENDER_NOTICE', 'estimatedValue', 'Estimated Value', 'number', false, true, '(?i)(estimated|value|amount)\\s*[:\\-]?\\s*([$€£]?\\s*[0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2})?)', 5, 'Estimated value of the tender')
            ON CONFLICT (document_type, field_key) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="018-003" author="dms">
        <comment>Insert default fields for CONTRACT_AGREEMENT document type</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, ocr_pattern, display_order, description)
            VALUES 
            ('CONTRACT_AGREEMENT', 'contractNumber', 'Contract Number', 'text', true, true, '(?i)contract\\s*(number|no\\.?|#)\\s*[:\\-]?\\s*([A-Z0-9\\-/]+)', 1, 'Contract reference number'),
            ('CONTRACT_AGREEMENT', 'vendorName', 'Vendor Name', 'text', true, true, '(?i)(vendor|supplier|contractor)\\s*(name)?\\s*[:\\-]?\\s*([A-Z][A-Za-z\\s]+)', 2, 'Name of the vendor/supplier'),
            ('CONTRACT_AGREEMENT', 'contractDate', 'Contract Date', 'date', true, true, '(?i)(contract|sign|execution)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 3, 'Date when contract was signed'),
            ('CONTRACT_AGREEMENT', 'contractAmount', 'Contract Amount', 'number', true, true, '(?i)(contract|total|amount)\\s*[:\\-]?\\s*([$€£]?\\s*[0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2})?)', 4, 'Total contract value'),
            ('CONTRACT_AGREEMENT', 'validityPeriod', 'Validity Period', 'text', false, false, null, 5, 'Contract validity period'),
            ('CONTRACT_AGREEMENT', 'expiryDate', 'Expiry Date', 'date', false, true, '(?i)(expiry|expiration|valid\\s*until)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 6, 'Contract expiry date')
            ON CONFLICT (document_type, field_key) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="018-004" author="dms">
        <comment>Insert default fields for BANK_GUARANTEE_BG document type</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, ocr_pattern, display_order, description)
            VALUES 
            ('BANK_GUARANTEE_BG', 'bgNumber', 'BG Number', 'text', true, true, '(?i)(bg|bank\\s*guarantee)\\s*(number|no\\.?|#)\\s*[:\\-]?\\s*([A-Z0-9\\-/]+)', 1, 'Bank Guarantee reference number'),
            ('BANK_GUARANTEE_BG', 'bankName', 'Bank Name', 'text', true, true, '(?i)(bank|issuing\\s*bank)\\s*(name)?\\s*[:\\-]?\\s*([A-Z][A-Za-z\\s]+)', 2, 'Name of issuing bank'),
            ('BANK_GUARANTEE_BG', 'bgAmount', 'BG Amount', 'number', true, true, '(?i)(amount|value)\\s*[:\\-]?\\s*([$€£]?\\s*[0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2})?)', 3, 'Bank Guarantee amount'),
            ('BANK_GUARANTEE_BG', 'issueDate', 'Issue Date', 'date', true, true, '(?i)(issue|issued)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 4, 'Date when BG was issued'),
            ('BANK_GUARANTEE_BG', 'expiryDate', 'Expiry Date', 'date', true, true, '(?i)(expiry|expiration|valid\\s*until)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 5, 'BG expiry date')
            ON CONFLICT (document_type, field_key) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="018-005" author="dms">
        <comment>Insert default fields for other document types</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, display_order, description)
            VALUES 
            ('TENDER_DOCUMENT', 'tenderId', 'Tender ID', 'text', true, true, 1, 'Associated tender identifier'),
            ('TENDER_DOCUMENT', 'documentCategory', 'Document Category', 'select', false, false, 2, 'Category of tender document'),
            ('PERFORMANCE_SECURITY_PS', 'psNumber', 'PS Number', 'text', true, true, 1, 'Performance Security reference number'),
            ('PERFORMANCE_SECURITY_PS', 'psAmount', 'PS Amount', 'number', true, true, 2, 'Performance Security amount'),
            ('PERFORMANCE_SECURITY_PS', 'expiryDate', 'Expiry Date', 'date', true, true, 3, 'PS expiry date'),
            ('PERFORMANCE_GUARANTEE_PG', 'pgNumber', 'PG Number', 'text', true, true, 1, 'Performance Guarantee reference number'),
            ('PERFORMANCE_GUARANTEE_PG', 'pgAmount', 'PG Amount', 'number', true, true, 2, 'Performance Guarantee amount'),
            ('PERFORMANCE_GUARANTEE_PG', 'expiryDate', 'Expiry Date', 'date', true, true, 3, 'PG expiry date')
            ON CONFLICT (document_type, field_key) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="018-006" author="dms">
        <comment>Update tenderType field options for TENDER_NOTICE with procurement method types</comment>
        <sql>
            UPDATE document_type_fields 
            SET field_options = '["OTM","DPM","OSTETM","RFQ","LTM","TSTM","LCS","QCBS","SSS"]'
            WHERE document_type = 'TENDER_NOTICE' 
            AND field_key = 'tenderType';
        </sql>
    </changeSet>

    <changeSet id="018-007" author="dms">
        <comment>Add tenderType field to TENDER_DOCUMENT with procurement method types</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, field_options, display_order, description)
            VALUES 
            ('TENDER_DOCUMENT', 'tenderType', 'Tender Type', 'select', false, false, '["OTM","DPM","OSTETM","RFQ","LTM","TSTM","LCS","QCBS","SSS"]', 3, 'Type of tender (OTM/DPM/OSTETM/RFQ/LTM/TSTM/LCS/QCBS/SSS)')
            ON CONFLICT (document_type, field_key) DO UPDATE 
            SET field_options = '["OTM","DPM","OSTETM","RFQ","LTM","TSTM","LCS","QCBS","SSS"]',
                field_label = 'Tender Type',
                field_type = 'select',
                description = 'Type of tender (OTM/DPM/OSTETM/RFQ/LTM/TSTM/LCS/QCBS/SSS)';
        </sql>
    </changeSet>

</databaseChangeLog>

