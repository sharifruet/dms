<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <changeSet id="024-001" author="dms">
        <comment>Deactivate APP document category (APP is no longer a document type)</comment>
        <update tableName="document_categories">
            <column name="is_active" valueBoolean="false"/>
            <where>name = 'APP'</where>
        </update>
    </changeSet>

    <changeSet id="024-002" author="dms">
        <comment>Add BILL document category</comment>
        <sql>
            INSERT INTO document_categories (name, display_name, description, is_active)
            SELECT 'BILL', 'Bill', 'Bill documents uploaded via image/PDF with OCR extraction', true
            WHERE NOT EXISTS (SELECT 1 FROM document_categories WHERE name = 'BILL');
        </sql>
    </changeSet>

    <changeSet id="024-003" author="dms">
        <comment>Add STATIONERY_RECORD document category if missing</comment>
        <sql>
            INSERT INTO document_categories (name, display_name, description, is_active)
            SELECT 'STATIONERY_RECORD', 'Stationery Record', 'Stationery tracking records', true
            WHERE NOT EXISTS (SELECT 1 FROM document_categories WHERE name = 'STATIONERY_RECORD');
        </sql>
    </changeSet>

    <changeSet id="024-004" author="dms">
        <comment>Migrate existing APP documents to OTHER type for backward compatibility</comment>
        <sql>
            UPDATE documents
            SET document_type = 'OTHER'
            WHERE document_type = 'APP';
        </sql>
    </changeSet>

    <changeSet id="024-005" author="dms">
        <comment>Add default fields for BILL document type</comment>
        <sql>
            INSERT INTO document_type_fields (document_type, field_key, field_label, field_type, is_required, is_ocr_mappable, ocr_pattern, display_order, description)
            VALUES 
            ('BILL', 'vendorName', 'Vendor Name', 'text', true, true, '(?i)(vendor|supplier)\\s*(name)?\\s*[:\\-]?\\s*([A-Z][A-Za-z\\s]+)', 1, 'Vendor or supplier name'),
            ('BILL', 'invoiceNumber', 'Invoice Number', 'text', true, true, '(?i)(invoice|bill)\\s*(number|no\\.?|#)\\s*[:\\-]?\\s*([A-Z0-9\\-/]+)', 2, 'Invoice reference number'),
            ('BILL', 'invoiceDate', 'Invoice Date', 'date', true, true, '(?i)(invoice|bill|date)\\s*(date)?\\s*[:\\-]?\\s*(\\d{1,2}[\\-/]\\d{1,2}[\\-/]\\d{2,4})', 3, 'Date of invoice'),
            ('BILL', 'fiscalYear', 'Fiscal Year', 'text', true, true, '(?i)(fiscal|financial)\\s*(year|yr\\.?)\\s*[:\\-]?\\s*(\\d{4}[\\-/]\\d{2,4})', 4, 'Fiscal year'),
            ('BILL', 'totalAmount', 'Total Amount', 'number', true, true, '(?i)(total|grand\\s*total|amount)\\s*[:\\-]?\\s*([$€£]?\\s*[0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2})?)', 5, 'Total bill amount'),
            ('BILL', 'taxAmount', 'Tax Amount', 'number', false, true, '(?i)(tax|vat|gst)\\s*(amount)?\\s*[:\\-]?\\s*([$€£]?\\s*[0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2})?)', 6, 'Tax amount if applicable')
            ON CONFLICT (document_type, field_key) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="024-006" author="dms">
        <comment>Deactivate APP document type fields (APP is no longer a document type)</comment>
        <sql>
            UPDATE document_type_fields
            SET is_required = false
            WHERE document_type = 'APP';
        </sql>
    </changeSet>

</databaseChangeLog>

